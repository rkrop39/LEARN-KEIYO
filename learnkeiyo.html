import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithCustomToken, 
  onAuthStateChanged,
  signInAnonymously,
  signOut,
} from 'firebase/auth';
import { 
  getFirestore,
  doc,
  setDoc,
  getDoc,
  onSnapshot,
  updateDoc,
  increment
} from 'firebase/firestore';
import { 
  Trophy, Home, Flame, Settings, Search, ArrowRightLeft, 
  Moon, Sun, BookOpen, LogOut, User, Sparkles, 
  ChevronRight, Lock, Eye, EyeOff, CheckCircle2, XCircle, Download
} from 'lucide-react';

// --- FIREBASE INITIALIZATION ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'learn-keiyo-v2-pro';

// --- DATA ---
const VOCABULARY = {
  greetings: [
    { keiyo: "Achamgei", sw: "Niko salama", en: "I am fine" },
    { keiyo: "Chamge", sw: "Habari", en: "Hello" },
    { keiyo: "Inye anye?", sw: "Na wewe?", en: "And you?" },
    { keiyo: "Jioni chamge", sw: "Habari ya jioni", en: "Good evening" },
    { keiyo: "Kacham", sw: "Nimekukubali", en: "I accept you" },
    { keiyo: "Kamnyeit anyorun", sw: "Nimefurahi kukutana nawe", en: "Nice to meet you" },
    { keiyo: "Karibu", sw: "Karibu", en: "Welcome" },
    { keiyo: "Kongoi", sw: "Asante", en: "Thank you" },
    { keiyo: "Saisere", sw: "Kwaheri", en: "Goodbye" },
    { keiyo: "Subuyan chamge", sw: "Habari ya asubuhi", en: "Good morning" },
    { keiyo: "Yamonei?", sw: "U hali gani?", en: "How are you?" }
  ],
  numbers: [
    { keiyo: "Agenge", sw: "Moja", en: "One" },
    { keiyo: "Aeng", sw: "Mbili", en: "Two" },
    { keiyo: "Somok", sw: "Tatu", en: "Three" },
    { keiyo: "Angwan", sw: "Nne", en: "Four" },
    { keiyo: "Mut", sw: "Tano", en: "Five" },
    { keiyo: "Lo", sw: "Sita", en: "Six" },
    { keiyo: "Tisyet", sw: "Saba", en: "Seven" },
    { keiyo: "Siet", sw: "Nane", en: "Eight" },
    { keiyo: "Sogol", sw: "Tisa", en: "Nine" },
    { keiyo: "Taman", sw: "Kumi", en: "Ten" }
  ],
  conversations: [
    { keiyo: "Akwa kainet...", sw: "Jina langu ni...", en: "My name is..." },
    { keiyo: "Amache...", sw: "Nataka...", en: "I want..." },
    { keiyo: "Amu ne?", sw: "Kwa nini?", en: "Why?" },
    { keiyo: "Ano?", sw: "Wapi?", en: "Where?" },
    { keiyo: "Au?", sw: "Lini?", en: "When?" },
    { keiyo: "Iyaa?", sw: "Vipi?", en: "How?" },
    { keiyo: "Ingo?", sw: "Nani?", en: "Who?" },
    { keiyo: "Kainet ak?", sw: "Jina lako nani?", en: "What is your name?" }
  ],
  dictionary_az: [
    { keiyo: "Asis", sw: "Jua", en: "Sun" },
    { keiyo: "Bek", sw: "Maji", en: "Water" },
    { keiyo: "Chego", sw: "Maziwa", en: "Milk" },
    { keiyo: "Gaa", sw: "Nyumbani", en: "Home" },
    { keiyo: "Kimyet", sw: "Ugali", en: "Stiff porridge" },
    { keiyo: "Mursik", sw: "Maziwa ya mgando", en: "Sour milk" },
    { keiyo: "Ng'echer", sw: "Kiti", en: "Chair" },
    { keiyo: "Rop", sw: "Mvua", en: "Rain" },
    { keiyo: "Tulwet", sw: "Mlima", en: "Mountain" }
  ]
};

const ALL_ENTRIES = Object.values(VOCABULARY).flat();

const MODULES = [
  { id: 'm1', title: 'Greetings', icon: Sparkles, color: 'bg-emerald-500', dataKey: 'greetings' },
  { id: 'm2', title: 'Numbers', icon: Trophy, color: 'bg-orange-500', dataKey: 'numbers' },
  { id: 'm3', title: 'Conversation', icon: BookOpen, color: 'bg-indigo-500', dataKey: 'conversations' },
  { id: 'm4', title: 'Culture', icon: Flame, color: 'bg-rose-500', dataKey: 'dictionary_az' },
];

// --- AUTH SCREEN ---
const AuthScreen = ({ onAuthSuccess }) => {
  const [isLogin, setIsLogin] = useState(true);
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [showPass, setShowPass] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleAuth = async (e) => {
    e.preventDefault();
    if (loading) return;
    const cleanUsername = username.trim().toLowerCase();
    if (cleanUsername.length < 3) return setError("Username must be 3+ characters.");
    if (password.length < 4) return setError("Password must be 4+ characters.");

    setLoading(true);
    setError('');

    try {
      let currentUser = auth.currentUser;
      if (!currentUser) {
        const cred = await signInAnonymously(auth);
        currentUser = cred.user;
      }

      const credDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'credentials', cleanUsername);
      const credSnap = await getDoc(credDocRef);

      if (isLogin) {
        if (!credSnap.exists()) throw new Error("Username not found.");
        if (credSnap.data().password !== password) throw new Error("Incorrect password.");
        onAuthSuccess(cleanUsername);
      } else {
        if (credSnap.exists()) throw new Error("Username taken.");
        await setDoc(credDocRef, { password, username: cleanUsername, userId: currentUser.uid });
        const userDocRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'info');
        await setDoc(userDocRef, { username: cleanUsername, xp: 0, level: 1, streak: 0, createdAt: new Date().toISOString() });
        onAuthSuccess(cleanUsername);
      }
    } catch (err) {
      setError(err.message);
    } finally { 
      setLoading(false); 
    }
  };

  return (
    <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-50 dark:bg-slate-950 font-sans">
      <div className="w-full max-w-sm space-y-8 animate-in fade-in zoom-in duration-500">
        <div className="text-center space-y-2">
          <div className="w-20 h-20 bg-emerald-600 rounded-[2rem] flex items-center justify-center text-white mx-auto shadow-2xl shadow-emerald-500/20">
            <Sparkles size={40}/>
          </div>
          <h1 className="text-4xl font-black tracking-tighter dark:text-white">KEIYO<span className="text-emerald-600">PRO</span></h1>
          <p className="text-slate-400 font-bold text-sm text-balance">The language of champions.</p>
        </div>

        <div className="bg-white dark:bg-slate-900 p-8 rounded-[3rem] shadow-2xl border border-slate-100 dark:border-slate-800">
          <h2 className="text-2xl font-black mb-8 dark:text-white text-center">{isLogin ? 'Login' : 'Join Us'}</h2>
          <form onSubmit={handleAuth} className="space-y-5">
            <div className="relative">
              <User className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={20}/>
              <input 
                type="text" placeholder="Username" required value={username} onChange={e => setUsername(e.target.value)}
                className="w-full p-4 pl-12 rounded-2xl bg-slate-50 dark:bg-slate-800 dark:text-white outline-none focus:ring-4 ring-emerald-500/10 border-2 border-transparent focus:border-emerald-500 font-bold transition-all"
              />
            </div>
            <div className="relative">
              <Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={20}/>
              <input 
                type={showPass ? "text" : "password"} placeholder="Password" required value={password} onChange={e => setPassword(e.target.value)}
                className="w-full p-4 pl-12 pr-12 rounded-2xl bg-slate-50 dark:bg-slate-800 dark:text-white outline-none focus:ring-4 ring-emerald-500/10 border-2 border-transparent focus:border-emerald-500 font-bold transition-all"
              />
              <button type="button" onClick={() => setShowPass(!showPass)} className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">
                {showPass ? <EyeOff size={20}/> : <Eye size={20}/>}
              </button>
            </div>
            {error && <p className="text-rose-500 text-[10px] font-black uppercase text-center bg-rose-500/5 p-2 rounded-xl">{error}</p>}
            <button disabled={loading} className="w-full py-5 bg-emerald-600 text-white rounded-[1.5rem] font-black shadow-xl shadow-emerald-500/20 active:scale-95 transition-all">
              {loading ? 'Wait...' : (isLogin ? 'Enter App' : 'Create Account')}
            </button>
          </form>
          <button onClick={() => { setIsLogin(!isLogin); setError(''); }} className="w-full mt-8 text-slate-400 text-[10px] font-black uppercase tracking-widest hover:text-emerald-600 transition-colors">
            {isLogin ? "Don't have an account? Register" : "Already registered? Login"}
          </button>
        </div>
      </div>
    </div>
  );
};

// --- QUIZ COMPONENT ---
const Quiz = ({ module, onComplete, user }) => {
  const questions = useMemo(() => [...(VOCABULARY[module.dataKey] || [])].sort(() => Math.random() - 0.5), [module]);
  const [step, setStep] = useState(0);
  const [score, setScore] = useState(0);
  const [selected, setSelected] = useState(null);
  const [feedback, setFeedback] = useState(null);
  const current = questions[step];

  const options = useMemo(() => {
    if (!current) return [];
    const pool = ALL_ENTRIES.filter(e => e.keiyo !== current.keiyo);
    const distractors = pool.sort(() => Math.random() - 0.5).slice(0, 3);
    return [...distractors, current].sort(() => Math.random() - 0.5);
  }, [current]);

  const check = async (opt) => {
    if (selected) return;
    setSelected(opt.keiyo);
    const isCorrect = opt.keiyo === current.keiyo;
    setFeedback(isCorrect ? 'correct' : 'wrong');
    if (isCorrect) setScore(s => s + 1);

    setTimeout(() => {
      setFeedback(null);
      setSelected(null);
      if (step + 1 < questions.length) {
        setStep(s => s + 1);
      } else {
        const finalXP = score * 10;
        const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info');
        updateDoc(profileRef, { xp: increment(finalXP) }).catch(() => {});
        onComplete();
      }
    }, 1000);
  };

  if (!current) return null;

  return (
    <div className="space-y-6 animate-in slide-in-from-right duration-300">
      <div className="h-2 w-full bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden">
        <div className="h-full bg-emerald-500 transition-all duration-500" style={{ width: `${((step + 1) / questions.length) * 100}%` }} />
      </div>
      <div className="p-12 bg-white dark:bg-slate-900 rounded-[3rem] text-center border-2 border-slate-100 dark:border-slate-800 shadow-xl relative">
        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">English Word</p>
        <h3 className="text-4xl font-black dark:text-white tracking-tight">{current.en}</h3>
      </div>
      <div className="grid gap-3">
        {options.map((opt, i) => (
          <button 
            key={i} onClick={() => check(opt)} disabled={!!selected}
            className={`p-6 rounded-[1.5rem] font-bold border-2 transition-all ${
              selected === opt.keiyo 
                ? (opt.keiyo === current.keiyo ? 'bg-emerald-500 border-emerald-500 text-white' : 'bg-rose-500 border-rose-500 text-white')
                : 'bg-white dark:bg-slate-900 border-slate-100 dark:border-slate-800 dark:text-white active:scale-95'
            }`}
          >
            {opt.keiyo}
          </button>
        ))}
      </div>
    </div>
  );
};

// --- MAIN APP ---
export default function App() {
  const [user, setUser] = useState(null);
  const [sessionUsername, setSessionUsername] = useState(localStorage.getItem('keiyo-username'));
  const [authChecked, setAuthChecked] = useState(false);
  const [tab, setTab] = useState('home');
  const [darkMode, setDarkMode] = useState(() => localStorage.getItem('keiyo-theme') === 'dark');
  const [activeQuiz, setActiveQuiz] = useState(null);
  const [search, setSearch] = useState('');
  const [profile, setProfile] = useState({ username: 'Learner', xp: 0, level: 1 });
  const [deferredPrompt, setDeferredPrompt] = useState(null);

  // PWA Install Prompt Listener
  useEffect(() => {
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      setDeferredPrompt(e);
    });
  }, []);

  const handleInstall = async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') setDeferredPrompt(null);
  };

  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else if (!auth.currentUser) {
          await signInAnonymously(auth);
        }
      } catch (e) { console.error(e); }
      setAuthChecked(true);
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (darkMode) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
    localStorage.setItem('keiyo-theme', darkMode ? 'dark' : 'light');
  }, [darkMode]);

  useEffect(() => {
    if (!user || !sessionUsername) return;
    const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info');
    return onSnapshot(profileRef, (s) => s.exists() && setProfile(s.data()));
  }, [user, sessionUsername]);

  const handleLoginSuccess = (username) => {
    localStorage.setItem('keiyo-username', username);
    setSessionUsername(username);
  };

  const handleLogout = async () => {
    localStorage.removeItem('keiyo-username');
    setSessionUsername(null);
    setUser(null);
    await signOut(auth);
    window.location.reload();
  };

  const results = useMemo(() => {
    const q = search.toLowerCase().trim();
    const all = [...ALL_ENTRIES].sort((a, b) => a.keiyo.localeCompare(b.keiyo));
    return q ? all.filter(e => e.keiyo.toLowerCase().includes(q) || e.en.toLowerCase().includes(q)) : all.slice(0, 50);
  }, [search]);

  if (!authChecked) return <div className="min-h-screen flex items-center justify-center bg-slate-950 text-emerald-600 animate-pulse"><Sparkles size={48}/></div>;
  if (!sessionUsername) return <AuthScreen onAuthSuccess={handleLoginSuccess} />;

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-slate-950 dark:text-white transition-colors pb-32">
      <header className="p-6 flex justify-between items-center sticky top-0 bg-slate-50/80 dark:bg-slate-950/80 backdrop-blur-xl z-40">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-emerald-600 rounded-2xl flex items-center justify-center text-white shadow-lg"><Sparkles size={20}/></div>
          <div>
            <h1 className="font-black tracking-tighter text-lg leading-tight">KEIYO<span className="text-emerald-600">PRO</span></h1>
            <span className="text-[8px] font-black uppercase text-slate-400">Level {Math.floor(profile.xp / 100) + 1}</span>
          </div>
        </div>
        <div className="flex items-center gap-2">
          {deferredPrompt && (
            <button onClick={handleInstall} className="p-2 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 rounded-xl animate-bounce">
              <Download size={18}/>
            </button>
          )}
          <div className="bg-orange-500/10 text-orange-600 px-3 py-1.5 rounded-full flex items-center gap-1.5 text-xs font-black border border-orange-200">
            <Flame size={14} fill="currentColor"/> {profile.xp} XP
          </div>
        </div>
      </header>

      <main className="max-w-lg mx-auto p-6">
        {activeQuiz ? (
          <Quiz module={activeQuiz} onComplete={() => setActiveQuiz(null)} user={user} />
        ) : (
          <div className="space-y-8">
            {tab === 'home' && (
              <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div className="bg-emerald-600 p-8 rounded-[3rem] text-white shadow-2xl relative overflow-hidden">
                  <Sparkles className="absolute -right-4 -top-4 text-white/10" size={160}/>
                  <div className="relative z-10">
                    <p className="text-xs font-black uppercase tracking-[0.2em] opacity-80 mb-2">Daily Goal</p>
                    <h2 className="text-3xl font-black mb-4">Language of Champions</h2>
                    <p className="text-sm font-bold opacity-90">Achieve greatness through consistency.</p>
                  </div>
                </div>
                <div className="grid gap-4">
                  {MODULES.map(m => (
                    <button key={m.id} onClick={() => setActiveQuiz(m)} className="p-6 bg-white dark:bg-slate-900 rounded-[2.5rem] flex items-center gap-5 border border-slate-100 dark:border-slate-800 shadow-sm group hover:scale-[1.02] transition-all text-left">
                      <div className={`${m.color} p-5 rounded-[1.8rem] text-white`}><m.icon size={28}/></div>
                      <div className="flex-1">
                        <h4 className="font-black text-xl mb-1">{m.title}</h4>
                        <span className="text-[10px] text-slate-400 font-black uppercase">{VOCABULARY[m.dataKey].length} words</span>
                      </div>
                      <ChevronRight size={20} className="text-slate-300"/>
                    </button>
                  ))}
                </div>
              </div>
            )}

            {tab === 'dict' && (
              <div className="space-y-6">
                <div className="relative">
                  <Search className="absolute left-6 top-1/2 -translate-y-1/2 text-slate-400" size={20}/>
                  <input 
                    type="text" placeholder="Search..." value={search} onChange={e => setSearch(e.target.value)}
                    className="w-full p-6 pl-16 rounded-[2rem] bg-white dark:bg-slate-900 shadow-xl border-none font-bold"
                  />
                </div>
                <div className="grid gap-3">
                  {results.map((e, i) => (
                    <div key={i} className="p-6 bg-white dark:bg-slate-900 rounded-[2rem] border dark:border-slate-800">
                      <h5 className="text-2xl font-black text-emerald-600 mb-2">{e.keiyo}</h5>
                      <div className="flex gap-4 text-sm opacity-80">
                        <span><strong>EN:</strong> {e.en}</span>
                        <span><strong>SW:</strong> {e.sw}</span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {tab === 'profile' && (
              <div className="p-10 bg-white dark:bg-slate-900 rounded-[3.5rem] shadow-2xl space-y-10 border dark:border-slate-800">
                <div className="text-center">
                  <div className="w-28 h-28 bg-slate-100 dark:bg-slate-800 rounded-[2.5rem] flex items-center justify-center mx-auto text-emerald-600 mb-6"><User size={56}/></div>
                  <h3 className="text-3xl font-black">{profile.username}</h3>
                  <div className="bg-emerald-500/10 text-emerald-600 px-4 py-1.5 rounded-full text-[10px] font-black uppercase mt-2">Level {Math.floor(profile.xp / 100) + 1}</div>
                </div>
                <button onClick={() => setDarkMode(!darkMode)} className="w-full flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl font-black">
                  <div className="flex items-center gap-3">{darkMode ? <Moon size={16}/> : <Sun size={16}/>} Dark Mode</div>
                  <div className={`w-10 h-6 rounded-full p-1 ${darkMode ? 'bg-emerald-500' : 'bg-slate-300'}`}><div className={`w-4 h-4 bg-white rounded-full transition-transform ${darkMode ? 'translate-x-4' : ''}`} /></div>
                </button>
                <button onClick={handleLogout} className="w-full py-5 bg-rose-500/5 text-rose-500 rounded-[1.8rem] font-black border border-rose-500/10">Log Out</button>
              </div>
            )}
          </div>
        )}
      </main>

      <nav className="fixed bottom-8 left-1/2 -translate-x-1/2 w-[90%] max-w-sm bg-white/80 dark:bg-slate-900/80 backdrop-blur-2xl border dark:border-slate-800 rounded-[2.5rem] flex justify-around p-3 shadow-2xl z-50">
        {[
          { id: 'home', icon: Home, label: 'Learn' },
          { id: 'dict', icon: ArrowRightLeft, label: 'Dict' },
          { id: 'profile', icon: User, label: 'Me' }
        ].map(n => (
          <button key={n.id} onClick={() => {setTab(n.id); setActiveQuiz(null);}} className={`flex flex-col items-center p-3 px-8 rounded-3xl ${tab === n.id ? 'text-emerald-600 bg-emerald-500/10' : 'text-slate-400'}`}>
            <n.icon size={24}/><span className="text-[8px] font-black uppercase mt-1">{n.label}</span>
          </button>
        ))}
      </nav>
    </div>
  );
}